<!-- Page Content  -->
<div id="content" class="p-4 p-md-5">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">

            <button type="button" id="sidebarCollapse" class="btn btn-primary">
                <i class="fa fa-bars"></i>
                <span class="sr-only">Toggle Menu</span>
            </button>
            <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <i class="fa fa-bars"></i>
            </button>
            <div class="toggle-title-name">ประวัติการขาย</div>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">หน้าร้านค้า</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/store/report">ประวัติ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/store/category">สมุดอาหาร</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!------ Include the above in your HEAD tag ---------->

    <div class="emp-profile">
        <div class="row">
            <div class="col-md-12">
                <div class="profile-head">
                    <h3><%= global_data.store_name %></h3>
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="report-graph-tab" data-toggle="tab" href="#report-graph"
                                role="tab" aria-controls="report-graph" aria-selected="false">สรุป</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="report-tab" data-toggle="tab" href="#report" role="tab"
                                aria-controls="home" aria-selected="true">ประวัติยอดขาย</a>
                        </li>
                        <!-- <li class="nav-item">
                            <a class="nav-link" id="food_rating-tab" data-toggle="tab" href="#food_rating" role="tab"
                                aria-controls="home" aria-selected="true">รายการอาหารนิยม</a>
                        </li> -->

                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-5">
                <br>
            </div>
            <div class="col-md-12">
                <div class="tab-content profile-tab" id="myTabContent">
                    <!-- graph report -->
                    <div class="tab-pane fade show active" id="report-graph" role="tabpanel"
                        aria-labelledby="report-graph-tab">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="month" value="" id="selected_month" class="form-control" />
                            </div>
                        </div>
                        <br>

                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="data_chart"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="card card-body add-shadow">
                                    <div class="text-center mb-3 name_title_Nsd">
                                        <h3>สรุป</h3>
                                    </div>
                                    <div>
                                        <!-- money in -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5>รายรับ</h5>
                                            </div>
                                            <div class="col-md-6">
                                                <h5 id="income_avg">บาท</h5>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- table report -->
                    <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
                        <div class="row">
                            <div class="col">
                                <table id="TableID" class="table table-striped table-bordered" style="width:100%">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>วันที่</th>
                                            <th>เวลา</th>
                                            <th>นักเรียน</th>
                                            <th>สถานะ</th>
                                            <th>อาหาร</th>
                                            <!-- <th>แคลโลรี่</th> -->
                                            <th>เงินเข้า</th>

                                            <th>ผู้รับผิดชอบ</th>
                                        </tr>
                                    </thead>
                                    <% for (var i = 0 ; i < store_history_data.length ; i++) {%>
                                    <tr>
                                        <td><%= store_history_data[i].date.getDate() + "/" + (store_history_data[i].date.getMonth()+1) + "/" + store_history_data[i].date.getFullYear() %>
                                        </td>
                                        <td><%= ("0"+store_history_data[i].date.getHours()).slice(-2) + ":" + ("0"+store_history_data[i].date.getMinutes()).slice(-2) + ":" +  ("0"+store_history_data[i].date.getSeconds()).slice(-2) %>
                                        </td>
                                        <td><%= store_history_data[i].student_id %></td>
                                        <td><%= store_history_data[i].status %></td>
                                        <td><%= store_history_data[i].food_name %></td>
                                        <td><%= store_history_data[i].income %></td>
                                        <td><%= store_history_data[i].responsible %></td>
                                    </tr>
                                    <%}%>
                                    </table>
                            </div>
                        </div>
                    </div>
                     <!-- table report -->
                     <div class="tab-pane fade" id="food_rating" role="tabpanel" aria-labelledby="food_rating-tab">
                        <div class="row">
                            food rating
                        </div>
                    </div>
                    
                    
                </div>
            </div>
        </div>
    </div>
    

    </div>
</div>

<script>
$(document).ready(function() {
    $('#TableID').DataTable();

    getDate();
    get_data_start_page();

} );

// get data by select month and mode
$('#selected_month, #radio_select input').on('change',() => {
    // var radio_val = $("input[name='mode']:checked", '#radio_select').val();
    var select_month = $('#selected_month').val();
    console.log('month : ' + select_month);
    $.ajax({
        type:'GET',
        url:'/store/report/get_data_graph/?month='+select_month+'&mode=mode_income',
        success:(msg_back) => {
            console.log(msg_back);
            draw_income_chart(msg_back);
        }, 
        error:(msg_back) => {
            console.log(msg_back);
        }
    })
})

// change_month_set_income = (select_month) => {
//     $.get('/store/report/get_data_graph/?month='+select_month+'&mode=mode_income',(data) => {
//         processed_data = process_data(data,"income")
//         // var income_avg = average_data(processed_data);
//         var sum = 0;
//         processed_data.forEach(number => {
//             if (number != 0) {
//                 sum += number;
//             }
//         });
//         $('#income_avg').text(sum+' บาท');
//     })
// }

// today
var global_date = '';
getDate = () => {
    var today = new Date();
    console.log(today);
    global_date = today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2);
    $("#selected_month").val(global_date);
}

get_data_start_page = () => {
    $.get('/store/report/get_data_graph/?month='+global_date+'&mode=mode_income',(data) => {
        console.log('data from server : ',data);
        
        draw_income_chart(data);
        processed_data = process_data(data,"income")
        // var income_avg = average_data(processed_data);
        var sum = 0;
        processed_data.forEach(number => {
            if (number != 0) {
                sum += number;
            }
        });
        $('#income_avg').text(sum+' บาท');
    })
}

process_data = (data,mode) => {
    // console.log('data : '+data+ ' mode : '+mode );
    var data_unprocess = data.data_to_client;
    // console.log(data_unprocess);
    var init_data = 0;
    var data_process = [];
    for (let j = 1; j < 32; j++) {
        for (let i = 0; i < data_unprocess.length; i++) {
            // console.log('Data : ',data_unprocess[i]);
            var date = new Date(data_unprocess[i].date) ;
            // console.log('date : ',date);
            // console.log('Date : '+j);
            // console.log('date format : ',date.getDate());
            if (date.getDate() == j) {
                if (mode == 'income') {
                    init_data = Number(data_unprocess[i].income) + Number(init_data);
                }
                // console.log('Data : ',init_data);    
            }       
        }
        data_process.push(init_data)
        init_data = 0;
    }
    return data_process;
}


draw_income_chart = (data) => {
    // init data
    processed_data = process_data(data,"income")
    console.log('data process :',processed_data);
        // sum topup
    var sum = 0;
    processed_data.forEach(number => {
        if (number != 0) {
            sum += number;
            
        }
    });
    // var income_avg = average_data(processed_data);
    console.log('data process sum :',sum);
    $('#income_avg').text(sum+' บาท');

    // draw chart
    var ctx = $('#data_chart');
    var chart_data_month = {
        type: 'line',
        data:{
            labels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
            26, 27, 28, 29, 30, 31],
            datasets:[
                {
                    // data: [200, 0, 100, 0, 0, 0, 100, 300, 0, 100],
                    data:processed_data,
                    label: "รายรับ",
                    borderColor: "#54FC70",
                    fill: false
                }
            ]
        }
        
    };

    var calories_chart = new Chart(ctx,chart_data_month);
}

</script>